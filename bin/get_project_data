#!/usr/bin/env ruby

# https://developer.github.com/early-access/graphql/explorer/
# https://stackoverflow.com/questions/39666940/how-to-batch-github-graphql-api-queries

require 'graphql/client'
require 'graphql/client/http'

module Kernel
  # File activesupport/lib/active_support/core_ext/kernel/singleton_class.rb, line 3
  def class_eval(*args, &block)
    singleton_class.class_eval(*args, &block)
  end
end

module GitHub
  REPO_PATTERN = %r{url = git@github.com:(.+)/(.+)\.git}
  REPOS = File.read('.gitmodules').scan(REPO_PATTERN).each_with_index.map do |repo|
    { login: repo[0], name: repo[1] }
  end

  HTTP = GraphQL::Client::HTTP.new("https://api.github.com/graphql") do
    def headers(context)
      unless token = context[:access_token] || ENV['GITHUB_ACCESS_TOKEN']
        # $ GITHUB_ACCESS_TOKEN=abc123
        #   https://help.github.com/articles/creating-an-access-token-for-command-line-use
        # Get temporary access token from ~/.config/hub
        fail 'Missing GitHub access token. Get temporary access token from ~/.config/hub'
      end

      {
        'Authorization' => "Bearer #{token}"
      }
    end
  end

  fetch_latest_schema = false

  if fetch_latest_schema
    Schema = GraphQL::Client.load_schema(HTTP)
    GraphQL::Client.dump_schema(HTTP, "lib/github/graphql/schema.json")
  else
    Schema = GraphQL::Client.load_schema("lib/github/graphql/schema.json")
  end

  Client = GraphQL::Client.new(schema: Schema, execute: HTTP)

  # TODO: Use each_slice(29) to go through 29 at a time to avoid
  #       exceeding query complexity limit.
  query_body = REPOS[0..29].each_with_index.inject('') do |q, (repo, i)|
    query_id = "query#{i}"
    q << <<-QUERY
      #{query_id}: repositoryOwner(login: "#{repo[:login]}") {
        repository(name: "#{repo[:name]}") {
          ...RepoFragment
        }
      }
    QUERY
  end

  Query = GitHub::Client.parse <<-QUERY
    query {
      #{query_body}
    }

    fragment RepoFragment on Repository {
      name
      description
      descriptionHTML
      homepageURL
    }
  QUERY
end

variables = {}
client_context = { access_token: ENV['GITHUB_ACCESS_TOKEN'] }

response = GitHub::Client.query(GitHub::Query, variables: variables, context: client_context)

if response.errors.any?
  error_msg = response.errors.messages.values.join("/n")
  raise error_msg
end

response.data.data.each_with_index do |(query_id, result), i|
  puts query_id
  if result.nil? || result['repository'].nil?
    puts "No Result for #{GitHub::REPOS[i]}"
  else
    result['repository'].each do |field, value|
      puts "#{field}: #{value}"
    end
  end
  puts '-'*80
end
